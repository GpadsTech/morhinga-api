<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Dados MoRHInGA</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 20px;
    }
    th, td {
      border: 1px solid #aaa;
      padding: 8px;
      text-align: center;
    }
    th {
      background-color: #007acc;
      color: white;
    }
    button {
      margin-top: 15px;
      padding: 10px 20px;
      background-color: #007acc;
      border: none;
      color: white;
      cursor: pointer;
      border-radius: 4px;
    }
    button:hover {
      background-color: #005f99;
    }
    input[type="date"] {
      padding: 5px;
      margin-right: 10px;
    }
  </style>
</head>
<body>

  <h1>Consulta de Dados MoRHInGA</h1>

  <label for="dataInicio">Data Início:</label>
  <input type="date" id="dataInicio" />

  <label for="dataFim">Data Fim:</label>
  <input type="date" id="dataFim" />

  <button onclick="carregarDados()">Carregar Dados</button>
  <button onclick="baixarCSV()">Baixar CSV</button>

  <table id="tabelaDados" style="display:none;">
    <thead>
      <tr>
        <th>Data</th>
        <th>Hora</th>
        <th>Medida de Chuva Calculado</th>
        <th>Medida de Chuva Contagem</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

<script>
  let dadosAtuais = [];

  async function carregarDados() {
    const inicio = document.getElementById('dataInicio').value;
    const fim = document.getElementById('dataFim').value;
    if (!inicio || !fim) {
      alert('Por favor, selecione as datas de início e fim.');
      return;
    }

    let url = `https://api.morhinga.upe.br/api/pluviometros/intervalo?inicio=${inicio}&fim=${fim}`;

    try {
      const resposta = await fetch(url);
      if (!resposta.ok) {
        alert('Erro ao buscar os dados: ' + resposta.statusText);
        return;
      }
      dadosAtuais = await resposta.json();
      preencherTabela(dadosAtuais);
    } catch (error) {
      alert('Erro na requisição: ' + error.message);
    }
  }

  function preencherTabela(dados) {
    const tbody = document.querySelector('#tabelaDados tbody');
    tbody.innerHTML = '';

    if (dados.length === 0) {
      tbody.innerHTML = '<tr><td colspan="4">Nenhum dado encontrado para esse intervalo.</td></tr>';
      document.getElementById('tabelaDados').style.display = 'table';
      return;
    }

    dados.forEach(item => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${item.data || ''}</td>
        <td>${item.hora || ''}</td>
        <td>${item.medidaDeChuvaCalculado != null ? item.medidaDeChuvaCalculado : ''}</td>
        <td>${item.medidaDeChuvaContagem != null ? item.medidaDeChuvaContagem : ''}</td>
      `;
      tbody.appendChild(tr);
    });

    document.getElementById('tabelaDados').style.display = 'table';
  }

  function baixarCSV() {
    if (dadosAtuais.length === 0) {
      alert('Nenhum dado para exportar. Por favor, carregue os dados primeiro.');
      return;
    }

    const headers = ['Data', 'Hora', 'MedidaDeChuvaCalculado', 'MedidaDeChuvaContagem'];
    const linhas = dadosAtuais.map(dado =>
      [
        dado.data || '',
        dado.hora || '',
        dado.medidaDeChuvaCalculado != null ? dado.medidaDeChuvaCalculado : '',
        dado.medidaDeChuvaContagem != null ? dado.medidaDeChuvaContagem : ''
      ].join(';')
    );

    const csvContent = [headers.join(';'), ...linhas].join('\n');

    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `pluviometros_${new Date().toISOString().slice(0,10)}.csv`;
    a.click();
    URL.revokeObjectURL(url);
  }
</script>

</body>
</html>
